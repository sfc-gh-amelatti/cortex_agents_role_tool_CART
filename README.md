# Snowflake Agent Permissions Automation

This solution provides a comprehensive Snowflake Stored Procedure that automates least-permissions role generation for Snowflake Cortex Agents.

## Overview

The `GENERATE_AGENT_PERMISSIONS` stored procedure automates the process of:

1. **REST API Integration**: Makes calls to DESCRIBE agent objects and retrieves relevant analyst + search tools + agent database/schema information
2. **Semantic View Analysis**: Executes SQL queries to get individual semantic view YAML definitions and identifies underlying tables
3. **Permission Generation**: Returns comprehensive SQL output for permissions that an admin can execute

## Features

- ✅ **Automated Agent Discovery**: Can discover agent location if database/schema not provided
- ✅ **REST API Simulation**: Framework for making actual REST API calls to agent objects
- ✅ **Semantic View Processing**: Executes `SYSTEM$READ_YAML_FROM_SEMANTIC_VIEW` for each semantic view
- ✅ **YAML Parsing**: Extracts table permissions from semantic view YAML definitions
- ✅ **Comprehensive Permission Scripts**: Generates complete SQL scripts with role creation, user creation, and all necessary grants
- ✅ **Error Handling**: Robust error handling with detailed logging
- ✅ **Output Storage**: Stores generated scripts in configurable output tables
- ✅ **Helper Functions**: Additional functions for viewing and retrieving generated scripts

## Output

The procedure returns a status message and stores the generated SQL script in the specified output table.

### Generated SQL Script Structure

The generated script includes:

1. **Variable Definitions**: Configurable variables for role name, user name, password, and warehouse
2. **Role Creation**: Creates a dedicated role for the agent
3. **Agent Permissions**: Grants USAGE on the agent object itself
4. **Database/Schema Permissions**: Grants USAGE on required databases and schemas
5. **Semantic View Permissions**: Grants SELECT on semantic views
6. **Table Permissions**: Grants SELECT on underlying tables (from YAML analysis)
7. **Search Service Permissions**: Grants USAGE on Cortex Search services
8. **User Creation**: Creates a dedicated user (if requested)
9. **Warehouse Permissions**: Grants USAGE on the specified warehouse

### Example Generated Script

```sql
-- ================================================================================
-- =========================================================================================
-- AUTO-GENERATED LEAST-PRIVILEGE SCRIPT FOR AGENT: SNOWFLAKE_INTELLIGENCE.AGENTS.INFLUENCER_AI
-- Generated on: 2025-10-21 17:38:52
-- Generated by: Automated Agent Permissions Notebook
-- =========================================================================================

-- IMPORTANT: Review and adjust the placeholder variables below for your environment.
SET AGENT_ROLE_NAME = 'INFLUENCER_AI_USER_ROLE';
SET WAREHOUSE_NAME = 'COMPUTE_WH';

-- Create a dedicated role for the agent's permissions.
USE ROLE SECURITYADMIN; -- Or your own privileged role to assign permissions
CREATE ROLE IF NOT EXISTS IDENTIFIER($AGENT_ROLE_NAME);
GRANT ROLE IDENTIFIER($AGENT_ROLE_NAME) TO ROLE SYSADMIN; -- Optional: Allows SYSADMIN to manage the role.

-- Grant core permission to use the agent object itself.
GRANT USAGE ON AGENT SNOWFLAKE_INTELLIGENCE.AGENTS.INFLUENCER_AI TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- Grant permissions on the underlying database objects required by the agent's tools.
-- NOTE: These permissions are derived from the agent's tool specification and semantic view YAML definitions.

-- Database and Schema USAGE grants (including agent location, tool-specific locations, tables from semantic views, procedures, and stages)
GRANT USAGE ON DATABASE db1 TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON DATABASE db2 TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON DATABASE SNOWFLAKE_INTELLIGENCE TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON SCHEMA db1.schema1 TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON SCHEMA db2.INFLUENCER TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON SCHEMA db2.RETAIL TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT USAGE ON SCHEMA SNOWFLAKE_INTELLIGENCE.AGENTS TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- Permissions for 'cortex_analyst_text_to_sql' tools
-- Semantic view permissions
GRANT SELECT ON VIEW db2.RETAIL.METRICS_VIEW TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- Base table permissions (from semantic view YAML)
GRANT SELECT ON TABLE db1.schema1.SUPPORT_TICKETS TO ROLE IDENTIFIER($AGENT_ROLE_NAME);
GRANT SELECT ON TABLE db2.INFLUENCER.INFLUENCER_METRICS TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- Permissions for 'cortex_search' tools
GRANT USAGE ON CORTEX SEARCH SERVICE db2.INFLUENCER.VIDEOS_SEARCH_SERVICE TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- Permissions for 'generic' tools (procedures)


-- Stage permissions for semantic model files

GRANT READ ON STAGE db1.schema1.SEMANTIC_MODELS TO ROLE IDENTIFIER($AGENT_ROLE_NAME);


-- Tool-specific warehouse permissions
GRANT USAGE ON WAREHOUSE IDENTIFIER('db1_WH') TO ROLE IDENTIFIER($AGENT_ROLE_NAME); -- Required for tool: metrics_analyst

-- Grant warehouse usage to the role for the user's session.
GRANT USAGE ON WAREHOUSE IDENTIFIER($WAREHOUSE_NAME) TO ROLE IDENTIFIER($AGENT_ROLE_NAME);

-- =========================================================================================
SELECT 'Setup complete for role ' || $AGENT_ROLE_NAME AS "Status";
-- =========================================================================================
```

## Best Practices

1. **Review Generated Scripts**: Always review generated scripts before execution
2. **Test in Non-Production**: Test the procedure in a non-production environment first
3. **Backup Existing Roles**: Backup existing roles before making changes
4. **Monitor Usage**: Monitor the usage of generated roles and users
5. **Regular Audits**: Regularly audit permissions to ensure they remain appropriate

## Support

For issues or questions:

1. Check the error messages in the output table
2. Verify your Snowflake permissions
3. Ensure all required packages are installed
4. Review the generated SQL scripts for syntax errors
